# learn-in-works

## Details

建立 DB 筆記

Creating a Simple Database

- https://www.youtube.com/watch?v=WQWSf6CdxMg

- https://stackoverflow.com/questions/17107324/database-creation-using-c-programming


##

一、數據以文本形式保存
第一步，就是將所要保存的數據，寫入文本文件。這個文本文件就是你的資料庫。

為了方便讀取，數據必須分成記錄，每一條記錄的長度規定為等長。比如，假定每條記錄的長度是800位元組，那麼第5條記錄的開始位置就在3200位元組。而大多數時候，我們不知道某一條記錄在第幾個位置，只知道主鍵（primary key）的值。這時為了讀取數據，可以一條條比對記錄。但是這樣做效率太低，實際應用中，資料庫往往採用B樹（B-tree）格式儲存數據。

二、什麼是 B 樹？

要理解 B 樹，必須從二叉查找樹（Binary search tree）講起。其二叉查找樹是一種查找效率非常高的數據結構，它有三個特點。

- (1) 每個節點最多只有兩個子樹。

- (2) 左子樹都為小於父節點的值，右子樹都為大於父節點的值。

- (3) 在 n 個節點中找到目標值，一般只需要log(n)次比較。

二叉查找樹的結構不適合資料庫，因為它的查找效率與層數相關。越處在下層的數據，就需要越多次比較。極端情況下，n個數據需要n次比較才能找到目標值。對於資料庫來說，每進入一層，就要從硬碟讀取一次數據，這非常致命，因為硬碟的讀取時間遠遠大於數據處理時間，資料庫讀取硬碟的次數越少越好。而 B 樹是對二叉查找樹的改進。它的設計思想是，將相關數據儘量集中在一起，以便一次讀取多個數據，減少硬碟操作次數。

B 樹的特點也有三個。

- (1) 一個節點可以容納多個值。比如上圖中，最多的一個節點容納了4個值。

- (2) 除非數據已經填滿，否則不會增加新的層。也就是說，B樹追求"層"越少越好。

- (3) 子節點中的值，與父節點中的值，有嚴格的大小對應關係。一般來說，如果父節點有 a 個值，那麼就有 a + 1 個子節點。比如上圖中，父節點有兩個值（ 7 和 16 ），就對應三個子節點，第一個子節點都是小於 7 的值，最後一個子節點都是大於 16的值，中間的子節點就是 7 和 16 之間的值。

這種數據結構，非常有利於減少讀取硬碟的次數。假定一個節點可以容納100個值，那麼3層的B樹可以容納100萬個數據，如果換成二叉查找樹，則需要20層！假定作業系統一次讀取一個節點，並且根節點保留在內存中，那麼B樹在100萬個數據中查找目標值，只需要讀取兩次硬碟。

三、索引

資料庫以B樹格式儲存，只解決了按照"主鍵"查找數據的問題。如果想查找其他欄位，就需要建立索引（index）。而所謂索引，就是以某個欄位為關鍵字的B樹文件。假定有一張"雇員表"，包含了員工號（主鍵）和姓名兩個欄位。可以對姓名建立索引文件，該文件以B樹格式對姓名進行儲存，每個姓名後面是其在資料庫中的位置（即第幾條記錄）。查找姓名的時候，先從索引中找到對應第幾條記錄，然後再從表格中讀取。

這種索引查找方法，叫做"索引順序存取方法"（Indexed Sequential Access Method），縮寫為 ISAM。它已經有多種實現（比如 C-ISAM 庫和 D-ISAM 庫），只要使用這些代碼庫，就能自己寫一個最簡單的資料庫。

四、高級功能

部署了最基本的數據存取（包括索引）以後，還可以實現一些高級功能。

- (1) SQL語言是資料庫通用操作語言，所以需要一個SQL解析器，將SQL命令解析為對應的ISAM操作。

- (2) 資料庫連接（join）是指資料庫的兩張表通過"外鍵"，建立連接關係。你需要對這種操作進行優化。

- (3) 資料庫事務 (transaction)是指批量進行一系列資料庫操作，只要有一步不成功，整個操作都不成功。所以需要有一個"操作日誌"，以便失敗時對操作進行回滾。

- (4) 備份機制：保存資料庫的副本。

- (5) 遠程操作：使得用戶可以在不同的機器上，通過 TCP/IP 協議操作資料庫。
